name: Codacy Analysis

on:
  push:
    branches: [ main, 'v[0-9]+.[0-9]+' ]
  pull_request:
    branches: [ main, 'v[0-9]+.[0-9]+' ]

jobs:
  codacy-analysis:
    name: Codacy Analysis
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Run Codacy Analysis CLI
      uses: codacy/codacy-analysis-cli-action@v4
      with:
        # Check https://github.com/codacy/codacy-analysis-cli#project-token to get your project token from your Codacy repository
        # You can also omit the token and run the tools that support default configurations
        api-token: ${{ secrets.CODACY_API_TOKEN }}
        verbose: true
        output: logs/codacy.sarif
        format: sarif
        # Adjust severity of non-security issues
        gh-code-scanning-compat: true
        # Force 0 exit code to allow SARIF file generation
        # This will handover control about PR rejection to the GitHub side
        max-allowed-issues: 2147483647
    - name: Upload Codacy's results file
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: logs/codacy.sarif
